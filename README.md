# Платформа Видеокурсов

Веб-платформа для размещения и продажи видеокурсов с системой управления пользователями и администрированием контента. Построена на Next.js с использованием PostgreSQL и NextAuth для аутентификации.

## Основные возможности

- **Каталог курсов** с фильтрацией и поиском
- **Система пользователей** с ролями (USER/ADMIN)
- **Администрирование** курсов, видео, новостей и пользователей
- **Загрузка видео** с автоматической генерацией постеров
- **Запросы на доступ** к платным курсам
- **Система новостей** с изображениями и модерацией
- **Отзывы и рейтинги** с системой одобрения
- **Форма обратной связи** с email уведомлениями
- **HTTPS поддержка** с собственными сертификатами
- **Стриминг видео** с защитой контента
- **Файловый менеджер** для управления медиа
- **Система логирования** действий администраторов

## Технологический стек

- **Frontend**: Next.js 15.4.6, React 19.1.0, Tailwind CSS 4.1.12
- **Backend**: Next.js API Routes, Node.js HTTPS сервер
- **База данных**: PostgreSQL 15 с Prisma ORM
- **Аутентификация**: NextAuth.js с Google OAuth
- **Email**: Resend для отправки уведомлений
- **State Management**: Zustand
- **Валидация**: Zod
- **Файловая система**: Multer для загрузки файлов

## Структура проекта

```
video-courses-mvp/
├── prisma/                    # База данных
│   ├── schema.prisma         # Схема БД
│   └── migrations/           # Миграции
├── src/
│   ├── app/                  # Next.js App Router
│   │   ├── admin/           # Админ панель
│   │   ├── api/             # API endpoints
│   │   ├── auth/            # Страницы аутентификации
│   │   ├── courses/         # Каталог курсов
│   │   └── videos/          # Просмотр видео
│   ├── components/          # React компоненты
│   │   ├── admin/          # Админ компоненты
│   │   ├── courses/        # Компоненты курсов
│   │   └── layout/         # Layout компоненты
│   ├── lib/                # Утилиты и конфигурация
│   ├── stores/             # Zustand stores
│   └── types/              # TypeScript типы
├── public/                 # Статические файлы
├── uploads/               # Загруженные файлы
│   ├── videos/           # Видеофайлы
│   └── thumbnails/       # Постеры
├── your-domain.com+2.pem      # SSL сертификат
├── your-domain.com+2-key.pem  # Приватный ключ
├── server.mjs                  # HTTPS сервер
└── docker-compose.yml         # PostgreSQL контейнер
```

## Установка и настройка

### Предварительные требования

- Node.js 18+ и npm
- Docker и Docker Compose
- Git
- Аккаунт на [Resend.com](https://resend.com) для отправки email

### 1. Клонирование репозитория

```bash
git clone <repository-url>
cd video-courses-mvp
```

### 2. Установка зависимостей

```bash
npm install
```

### 3. Настройка базы данных

Запуск PostgreSQL в Docker:

```bash
docker-compose up -d
```

### 4. Настройка переменных окружения

Создайте файл `.env` в корне проекта:

```env
# База данных
DATABASE_URL="postgresql://username:password@localhost:5432/database_name"

# NextAuth
AUTH_URL="https://your-domain.com"
AUTH_SECRET="your-auth-secret-here"

# Google OAuth (получите в Google Cloud Console)
AUTH_GOOGLE_ID="your-google-client-id"
AUTH_GOOGLE_SECRET="your-google-client-secret"

# Resend API для отправки email (получите на resend.com)
RESEND_API_KEY="re_your-resend-api-key"
```

#### Генерация AUTH_SECRET

Для генерации безопасного секретного ключа используйте:

```bash
# Вариант 1: OpenSSL
openssl rand -base64 32

# Вариант 2: Node.js
node -e "console.log(require('crypto').randomBytes(32).toString('base64'))"

# Вариант 3: NextAuth CLI
npx auth secret
```

### 5. Выполнение миграций

```bash
npx prisma migrate deploy
npx prisma generate
```

### 6. SSL сертификаты (для продакшена)

Для HTTPS создайте SSL сертификаты и разместите их в корневой папке проекта.

## Запуск приложения

### Режим разработки

```bash
# Next.js dev сервер (HTTP)
npm run dev

# Или HTTPS сервер для разработки
npm run start:dev
```

### Продакшн

```bash
# Сборка приложения
npm run build

# Запуск HTTPS сервера
npm run start:prod
```

## Доступ к приложению

- **Разработка**: https://localhost или http://localhost:3000
- **Продакшн**: https://your-domain.com

### Первый запуск и настройка админа

1. Перейдите на сайт
2. Войдите через Google аккаунт  
3. **ВАЖНО**: Назначьте себе роль администратора вручную в базе данных:

```sql
-- Подключитесь к базе данных
psql $DATABASE_URL

-- Найдите свой ID пользователя
SELECT id, email, role FROM users;

-- Назначьте роль ADMIN (замените YOUR_USER_ID на ваш ID)
UPDATE users SET role = 'ADMIN' WHERE id = 'YOUR_USER_ID';
```

4. **Обязательная настройка админских данных:**
   - Перейдите в админ панель → Настройки
   - Заполните **Email поддержки** (обязательно для работы формы обратной связи)
   - Опционально: телефон и Telegram поддержки
   
5. **Настройка Resend для email:**
   - Зарегистрируйтесь на [resend.com](https://resend.com)
   - Получите API ключ и добавьте в `.env`: `RESEND_API_KEY="re_..."`
   - Для продакшена: добавьте свой домен в Resend и настройте DNS

## Система ролей

### USER (Пользователь)
- Просмотр каталога курсов и новостей
- Доступ к бесплатным курсам и видео
- Запрос доступа к платным курсам
- Управление профилем и контактами
- Отправка отзывов и оценок
- Форма обратной связи

### ADMIN (Администратор)
- Все права пользователя
- Управление курсами, видео и новостями
- Обработка запросов на доступ к курсам
- Модерация отзывов пользователей
- Управление пользователями и доступами
- Загрузка и организация видеоконтента
- Файловый менеджер с очисткой неиспользуемых файлов
- Настройка контактов поддержки
- Просмотр логов системы


## Безопасность


### Аутентификация

- OAuth 2.0 через Google
- JWT токены для сессий
- Защита API роутов

### Защита контента

- Проверка доступа к видео
- Rate limiting для API
- Валидация загружаемых файлов



## Загрузка контента

### Видео

- Поддерживаемые форматы: MP4
- Автоматическая генерация постеров
- Валидация размера файлов
- Организация по папкам

### Постеры

- Автоматическая генерация из видео
- Поддержка пользовательских изображений
- Оптимизация размера

## Отладка и логирование

### Логи приложения

```bash
# PM2 логи
pm2 logs video-courses

# Логи в файлах
tail -f /var/log/pm2/video-courses.log
```

### База данных

```bash
# Подключение к БД
psql $DATABASE_URL

# Prisma Studio
npx prisma studio
```

## Деплой

```bash
# Клонирование и установка
git clone <repo>
cd video-courses-mvp
npm install

# Настройка БД
docker-compose up -d
npx prisma migrate deploy

# Сборка и запуск
npm run build
npm run start:prod
```

## Обновления

### Обновление

```bash
git pull origin main
npm install
npm run build
# Перезапустите сервер
```

## Система обратной связи

### Форма обратной связи
- Доступна на странице `/contacts`
- Отправляет email на адрес из админских настроек
- Использует сервис Resend для доставки
- Автоматическое логирование отправленных сообщений

### Настройка контактов поддержки
Обязательно настройте в админ панели → Настройки:
- **Email поддержки** - обязательное поле для работы формы обратной связи
- Телефон поддержки - опционально, отображается на странице контактов  
- Telegram поддержки - опционально, отображается на странице контактов

##  Важные замечания

### Безопасность админского доступа
- Роль ADMIN назначается только вручную через базу данных
- Никогда не создавайте автоматического назначения админских прав
- Регулярно проверяйте список администраторов в БД

### Email настройки
- В тестовом режиме Resend отправляет с `onboarding@resend.dev`
- Для продакшена настройте свой домен в Resend
- Email поддержки должен быть обязательно заполнен для работы формы
